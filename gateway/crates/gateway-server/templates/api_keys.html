{% extends "layout.html" %}

{% block content %}
{% match message %}
{% when Some with (msg) %}
<div class="bg-blue-900/50 border border-blue-700 text-blue-200 px-4 py-3 rounded mb-6">
    {{ msg }}
</div>
{% when None %}
{% endmatch %}

{% match new_key %}
{% when Some with (key) %}
<div class="bg-green-900/50 border border-green-700 text-green-200 px-4 py-3 rounded mb-6">
    <p class="font-semibold mb-2">Your new API key (copy now, won't be shown again):</p>
    <code class="block bg-dark-700 px-4 py-2 rounded font-mono text-sm break-all select-all">{{ key }}</code>
</div>
{% when None %}
{% endmatch %}

<!-- Generate Key Form -->
<div class="bg-dark-800 rounded-lg border border-dark-600 p-6 mb-8">
    <h3 class="text-lg font-semibold mb-4">Generate API Key</h3>
    <form method="POST" action="/admin/keys/generate" class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-400 mb-2">Key Name</label>
            <input type="text" name="name" required placeholder="Production API"
                   class="w-full px-4 py-2 bg-dark-700 border border-dark-600 rounded-lg text-gray-100 placeholder-gray-500 focus:ring-2 focus:ring-primary focus:border-transparent">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-400 mb-2">Rate Limit (RPM)</label>
            <input type="number" name="rate_limit_rpm" placeholder="60"
                   class="w-full px-4 py-2 bg-dark-700 border border-dark-600 rounded-lg text-gray-100 placeholder-gray-500 focus:ring-2 focus:ring-primary focus:border-transparent">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-400 mb-2">Token Limit (TPM)</label>
            <input type="number" name="rate_limit_tpm" placeholder="100000"
                   class="w-full px-4 py-2 bg-dark-700 border border-dark-600 rounded-lg text-gray-100 placeholder-gray-500 focus:ring-2 focus:ring-primary focus:border-transparent">
        </div>
        <div class="flex items-end">
            <button type="submit"
                    class="w-full px-4 py-2 bg-secondary text-dark-900 font-semibold rounded-lg hover:bg-secondary/90 transition duration-200">
                Generate Key
            </button>
        </div>
    </form>
</div>

<!-- API Keys List -->
<div class="bg-dark-800 rounded-lg border border-dark-600 overflow-hidden">
    <table class="w-full">
        <thead class="bg-dark-700">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Key</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Rate Limits</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Last Used</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-dark-600" id="keys-table">
            {% for key in api_keys %}
            <tr id="key-{{ key.id }}">
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="text-gray-100 font-medium">{{ key.name }}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <code class="text-gray-400 font-mono text-sm">{{ key.key_prefix }}********</code>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <span class="text-gray-400">
                        {% match key.rate_limit_rpm %}{% when Some with (rpm) %}{{ rpm }} RPM{% when None %}-{% endmatch %}
                        /
                        {% match key.rate_limit_tpm %}{% when Some with (tpm) %}{{ tpm }} TPM{% when None %}-{% endmatch %}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 text-xs rounded-full {% if key.enabled %}bg-green-900/50 text-green-400{% else %}bg-red-900/50 text-red-400{% endif %}">
                        {% if key.enabled %}Active{% else %}Revoked{% endif %}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">
                    {% match key.last_used_at %}
                    {% when Some with (last_used) %}{{ last_used.format("%Y-%m-%d %H:%M") }}
                    {% when None %}<span class="text-gray-500">Never</span>{% endmatch %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                    <button hx-post="/admin/keys/{{ key.id }}/toggle"
                            hx-target="#key-{{ key.id }}"
                            hx-swap="outerHTML"
                            class="text-primary hover:text-primary/80 mr-3">
                        Toggle
                    </button>
                    <button hx-post="/admin/keys/{{ key.id }}/revoke"
                            hx-target="#key-{{ key.id }}"
                            hx-swap="outerHTML"
                            hx-confirm="Are you sure you want to revoke this API key? This action cannot be undone."
                            class="text-red-400 hover:text-red-300">
                        Revoke
                    </button>
                </td>
            </tr>
            {% endfor %}
            {% if api_keys.is_empty() %}
            <tr>
                <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                    No API keys generated yet. Generate one above to get started.
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% endblock %}
